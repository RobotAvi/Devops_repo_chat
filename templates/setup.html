<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Настройка · Multi‑Repo Q&A</title>
    <link rel="stylesheet" href="/static/setup.css" />
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="brand">
                <div class="logo">MR</div>
                <div>
                    <h1>Multi‑Repo Q&A</h1>
                    <p>Премиальная настройка окружения</p>
                </div>
            </div>

            <form id="setupForm" onsubmit="return false;">
                <div class="field">
                    <label>GitLab Base URL</label>
                    <input type="url" id="gitlab_base_url" placeholder="https://webgit.korusconsulting.ru/api/v4" required />
                    <button class="ghost" type="button" onclick="validateGitlab()">Проверить</button>
                    <div class="hint" id="gitlab_hint"></div>
                </div>

                <div class="field">
                    <label>GitLab Token</label>
                    <input type="password" id="gitlab_token" placeholder="Ваш GitLab PAT" required />
                </div>

                <div class="field">
                    <label>LLM API Key</label>
                    <input type="password" id="llm_api_key" placeholder="токен для vLLM / OpenAI" />
                </div>

                <div class="field">
                    <label>LLM Base URL</label>
                    <input type="url" id="llm_base_url" placeholder="https://llm.internal/v1" />
                </div>

                <div class="field">
                    <label>LLM Model</label>
                    <input type="text" id="llm_model" placeholder="gpt-4o-mini или свой" />
                </div>

                <div class="field">
                    <label>Embeddings API Key</label>
                    <input type="password" id="embedding_api_key" placeholder="ключ для эмбеддингов (опционально)" />
                </div>

                <div class="field">
                    <label>Embeddings Base URL</label>
                    <input type="url" id="embedding_base_url" placeholder="https://embeddings.internal/v1 (опционально)" />
                    <button class="ghost" type="button" onclick="validateOpenAI()">Проверить</button>
                    <div class="hint" id="openai_hint"></div>
                </div>

                <div class="field">
                    <label>Embeddings Model</label>
                    <input type="text" id="embedding_model" placeholder="text-embedding-3-small (по умолчанию)" />
                </div>

                <div class="actions">
                    <button type="submit" onclick="saveConfig()" class="primary">Сохранить и продолжить</button>
                </div>
            </form>

            <div class="projects">
                <h2>Репозитории</h2>
                <div class="field">
                    <label>Поиск проектов</label>
                    <input type="text" id="search" placeholder="введите часть имени" />
                    <button class="ghost" type="button" onclick="loadProjects()">Найти</button>
                </div>
                <div id="project_list" class="list"></div>
            </div>
        </div>
    </div>

    <script>
        async function validateGitlab() {
            const base_url = document.getElementById('gitlab_base_url').value.trim();
            const token = document.getElementById('gitlab_token').value.trim();
            const res = await fetch('/setup/validate/gitlab', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({base_url, token})
            });
            const data = await res.json();
            const hint = document.getElementById('gitlab_hint');
            hint.textContent = data.ok ? 'GitLab доступен' : `Ошибка: ${data.error}`;
            hint.className = 'hint ' + (data.ok ? 'ok' : 'err');
        }

        async function validateOpenAI() {
            const api_key = document.getElementById('embedding_api_key').value.trim() || document.getElementById('llm_api_key').value.trim();
            const base_url = document.getElementById('embedding_base_url').value.trim() || document.getElementById('llm_base_url').value.trim();
            const model = document.getElementById('embedding_model').value.trim() || document.getElementById('llm_model').value.trim();
            const res = await fetch('/setup/validate/openai', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({api_key, base_url, model})
            });
            const data = await res.json();
            const hint = document.getElementById('openai_hint');
            hint.textContent = data.ok ? 'Ключ принят' : `Ошибка: ${data.error}`;
            hint.className = 'hint ' + (data.ok ? 'ok' : 'err');
        }

        async function saveConfig() {
            const gitlab_base_url = document.getElementById('gitlab_base_url').value.trim();
            const gitlab_token = document.getElementById('gitlab_token').value.trim();
            const llm_api_key = document.getElementById('llm_api_key').value.trim();
            const llm_base_url = document.getElementById('llm_base_url').value.trim();
            const llm_model = document.getElementById('llm_model').value.trim();
            const embedding_api_key = document.getElementById('embedding_api_key').value.trim();
            const embedding_base_url = document.getElementById('embedding_base_url').value.trim();
            const embedding_model = document.getElementById('embedding_model').value.trim();
            const res = await fetch('/setup/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({gitlab_base_url, gitlab_token, llm_api_key, llm_base_url, llm_model, embedding_api_key, embedding_base_url, embedding_model})
            });
            const data = await res.json();
            if (data.ok) {
                window.location.href = '/';
            }
        }

        async function loadProjects() {
            const q = document.getElementById('search').value.trim();
            const res = await fetch('/setup/projects' + (q ? ('?q=' + encodeURIComponent(q)) : ''));
            const data = await res.json();
            const box = document.getElementById('project_list');
            box.innerHTML = '';
            if (!data.ok) {
                box.textContent = 'Ошибка загрузки: ' + data.error;
                return;
            }
            data.projects.forEach(p => {
                const div = document.createElement('div');
                div.className = 'item';
                div.textContent = p.path_with_namespace;
                box.appendChild(div);
            });
        }
    </script>
</body>
<!-- Minimal, premium-inspired: dark, glass, subtle gradients -->
</html>

